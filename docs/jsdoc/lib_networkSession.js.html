<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/networkSession.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/networkSession.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
    ClientError,
    _fetch
} from './util.js';
import EventTarget from "../third_party/event-target/esm/index.js";
/**
 *
 *
 * @export
 * @class NetworkSession
 * @extends {EventTarget}
 * @param api
 * @param [idToken=null]
 */
export class NetworkSession extends EventTarget {

    constructor(api, idToken = null) {
        super();
        this.sessionId = undefined;
        this.API_URL = api;
        this.idToken = idToken;
        this.sessionComponents = [];
        this.networkConfig = null;
    }
    /**
     *
     *
     * @return
     * @memberof NetworkSession
     */
    async keepalive() {
        if (!this.sessionId)
            return;
        _fetch(`${this.API_URL}/sessions/${this.sessionId}/keepalive`, "POST", null, this.idToken);
    }
    /**
     *
     *
     * @return
     * @memberof NetworkSession
     */
    async release() {
        if (!this.sessionId)
            return;

        await _fetch(`${this.API_URL}/sessions/${this.sessionId}`, "DELETE", null, this.idToken);
        this.sessionId = undefined;
    }
    /**
     *
     *
     * @return
     * @memberof NetworkSession
     */
    async wsConnection() {

        if (this.sessionId == null) {
            return null;
        }
        const url = `${this.API_URL}/networks/${this.sessionId}/wsConnection`;
        const res = await _fetch(url, "GET", null, this.idToken);

        if (!res.ok)
            throw new Error(await res.text());

        const url2 = new URL(res.wsConnection, this.API_URL);
        if (url2.port === "443")
            url2.protocol = "wss";
        return String(url2);
    }
    /**
     *
     *
     * @param sessionId
     * @param sessions
     * @param options
     * @memberof NetworkSession
     */
    load(sessionId, sessions, options) {
        this.sessionId = sessionId;
        for (const session of sessions) {
            this.sessionComponents.push(session);
            session.setNetwork(this);
        }
        this.networkConfig = options;
    }
    /**
     *
     *
     * @param componentId
     * @return
     * @memberof NetworkSession
     */
    getNetworkConfig(componentId) {
        for (let compConfig of this.networkConfig.components) {
            if (compConfig.componentId === componentId)
                return compConfig;
        }
        return null;
    }
    /**
     *
     *
     * @param sessions
     * @param options
     * @memberof NetworkSession
     */
    async startNetwork(sessions, options) {
        for (const session of sessions) {
            let netComponent = session.request.getNetworkConfig();
            if (!netComponent) {
                console.log("network session component not configured");
                continue;
            }
            netComponent.setComponentId(session.componentId);
            options.getNetworkConfig().addNetworkComponent(netComponent);
            this.sessionComponents.push(session);
        }

        let result = await _fetch(`${this.API_URL}/networks`, "POST", options.getNetworkConfig().build(), this.idToken);
        this.sessionId = result.id;
        this.networkConfig = options.getNetworkConfig().build();
        this.networkTcpInfo = result.networkUrls != null ? result.networkUrls.tcp : null;
        for (const session of this.sessionComponents) {
            session.setNetwork(this);
        }
    }

    /**
     *
     *
     * @return
     * @memberof NetworkSession
     */
    getId() {
        return this.sessionId;
    }

    async disconnect(compid) {
        console.log("disconnect component " + compid + " from network " + this.sessionId);
        await _fetch(`${this.API_URL}/networks/${this.sessionId}/disconnect/${compid}`, "POST", null, this.idToken);
    }

    async remove(compid) {
        console.log("Removing component " + compid + " from network " + this.sessionId);
        await _fetch(`${this.API_URL}/networks/${this.sessionId}/components/${compid}`, "DELETE", null, this.idToken);
    }
    /**
     *
     *
     * @param id
     * @return
     * @memberof NetworkSession
     */
    getSession(id) {
        for (let session of this.sessionComponents) {
            if (session.componentId === id)
                return session;
        }
        throw new Error("session not found");
    }
    /**
     *
     *
     * @return
     * @memberof NetworkSession
     */
    getSessions() {
        return this.sessionComponents;
    }
    /**
     *
     *
     * @param netEnvId
     * @param oldEnv
     * @param newEnv
     * @return
     * @memberof NetworkSession
     */
    async updateNetwork(netEnvId, oldEnv, newEnv) {
        try {
            let net = await _fetch(`${this.API_URL}/network-environments/${netEnvId}`, "GET", null, this.idToken);

            net.emilEnvironments.forEach(element => {
                if (element.envId === oldEnv)
                    element.envId = newEnv;
            });

            let result = await _fetch(`${this.API_URL}/network-environments`, "POST", net, this.idToken);
            return result;
        } catch (e) {
            throw new ClientError("update network failed", e);
        }
    }
    /**
     *
     *
     * @param name
     * @param detachTime_minutes
     * @memberof NetworkSession
     */
    async detach(name, detachTime_minutes) {
        console.log("detaching session " + this.sessionId);
        let res = await _fetch(`${this.API_URL}/sessions/${this.sessionId}/detach`, "POST", {
            lifetime: detachTime_minutes,
            lifetime_unit: "minutes",
            sessionName: name,
        }, this.idToken);
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a></li><li><a href="ClientError.html">ClientError</a></li><li><a href="ClientOptions.html">ClientOptions</a></li><li><a href="ComponentBuilder.html">ComponentBuilder</a></li><li><a href="ComponentOptions.html">ComponentOptions</a></li><li><a href="ComponentSession.html">ComponentSession</a></li><li><a href="ContainerBuilder.html">ContainerBuilder</a></li><li><a href="ContainerImageBuilder.html">ContainerImageBuilder</a></li><li><a href="ContainerRuntimeBuilder.html">ContainerRuntimeBuilder</a></li><li><a href="EmulatorBuilder.html">EmulatorBuilder</a></li><li><a href="InputBuilder.html">InputBuilder</a></li><li><a href="InputContentBuilder.html">InputContentBuilder</a></li><li><a href="MachineComponentBuilder.html">MachineComponentBuilder</a></li><li><a href="NetworkBuilder.html">NetworkBuilder</a></li><li><a href="NetworkComponentConfig.html">NetworkComponentConfig</a></li><li><a href="NetworkConfig.html">NetworkConfig</a></li><li><a href="NetworkSession.html">NetworkSession</a></li><li><a href="SaveImportRequest.html">SaveImportRequest</a></li><li><a href="SaveNewEnvironmentRequest.html">SaveNewEnvironmentRequest</a></li><li><a href="SaveObjectEnvironmentRequest.html">SaveObjectEnvironmentRequest</a></li><li><a href="SaveRevisionRequest.html">SaveRevisionRequest</a></li><li><a href="SaveUserSessionRequest.html">SaveUserSessionRequest</a></li><li><a href="TcpGatewayConfig.html">TcpGatewayConfig</a></li><li><a href="TransformStream.html">TransformStream</a></li><li><a href="UviMachineComponentBuilder.html">UviMachineComponentBuilder</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_fetch">_fetch</a></li><li><a href="global.html#assignRandomMac">assignRandomMac</a></li><li><a href="global.html#BwflaMouse">BwflaMouse</a></li><li><a href="global.html#hideClientCursor">hideClientCursor</a></li><li><a href="global.html#onmousedown">onmousedown</a></li><li><a href="global.html#onmousemove">onmousemove</a></li><li><a href="global.html#onmouseup">onmouseup</a></li><li><a href="global.html#requestPointerLock">requestPointerLock</a></li><li><a href="global.html#sendAltTab">sendAltTab</a></li><li><a href="global.html#sendEsc">sendEsc</a></li><li><a href="global.html#showClientCursor">showClientCursor</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Fri Oct 08 2021 14:23:23 GMT+0200 (Mitteleurop√§ische Sommerzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
